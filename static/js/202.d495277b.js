"use strict";(self.webpackChunkrustwebui_frontend=self.webpackChunkrustwebui_frontend||[]).push([["202"],{585(e,t,i){i.d(t,{EVENT_TYPES:()=>v,emit:()=>o,forwardToBackend:()=>E,subscribe:()=>s});let n=new class{constructor(){this.listeners=new Map,this.middleware=[],this.history=[],this.maxHistorySize=100,this.backendListeners=new Map,this.webuiAvailable=void 0!==window.webui}subscribe(e,t,i={}){this.listeners.has(e)||this.listeners.set(e,[]);let n={callback:t,id:this.generateId(),once:i.once||!1,filter:i.filter||null,priority:i.priority||0,context:i.context||null};return this.listeners.get(e).push(n),this.sortListenersByPriority(e),console.debug(`Subscribed to event: ${e}`,{subscriptionId:n.id}),()=>{this.unsubscribe(e,n.id)}}subscribeOnce(e,t,i={}){return this.subscribe(e,t,{...i,once:!0})}unsubscribe(e,t){if(this.listeners.has(e)){let i=this.listeners.get(e),n=i.findIndex(e=>e.id===t);-1!==n&&(i.splice(n,1),console.debug(`Unsubscribed from event: ${e}`,{subscriptionId:t}))}}async emit(e,t=null,i={}){let n;for(let s of(n="string"==typeof e?{id:this.generateId(),name:e,data:t,timestamp:Date.now(),source:"frontend",metadata:{...i,source:"frontend"}}:{id:this.generateId(),timestamp:Date.now(),source:"frontend",...e,metadata:{...e.metadata,source:"frontend"}},console.debug(`Emitting event: ${n.name}`,{eventId:n.id,data:n.data}),this.addToHistory(n),this.middleware))try{let e=await Promise.resolve(s(n));if(!1===e)return void console.debug(`Middleware cancelled event: ${n.name}`)}catch(e){console.error("Error in event middleware:",e)}let s=this.listeners.get(n.name)||[],r=[];for(let e of s)try{if(e.filter&&!e.filter(n)){r.push(e);continue}let t=e.context||this,i=await Promise.resolve(e.callback.call(t,n));if(e.once||r.push(e),!1===i){console.debug(`Event propagation stopped by listener: ${n.name}`);break}}catch(e){console.error(`Error in event listener for ${n.name}:`,e)}r.length!==s.length&&this.listeners.set(n.name,r),this.emitAsDOMEvent(n)}emitAsDOMEvent(e){let t=new CustomEvent(e.name,{detail:{id:e.id,name:e.name,data:e.data,timestamp:e.timestamp,source:e.source,metadata:e.metadata}});window.dispatchEvent(t)}use(e){return this.middleware.push(e),()=>{let t=this.middleware.indexOf(e);-1!==t&&this.middleware.splice(t,1)}}addToHistory(e){this.history.push(e),this.history.length>this.maxHistorySize&&this.history.shift()}getHistory(e=null){return e?this.history.filter(t=>t.name===e):[...this.history]}clearHistory(){this.history=[]}getEventNames(){return Array.from(this.listeners.keys())}getListenerCount(e){return this.listeners.has(e)?this.listeners.get(e).length:0}generateId(){return Date.now().toString(36)+Math.random().toString(36).substr(2,5)}sortListenersByPriority(e){this.listeners.has(e)&&this.listeners.get(e).sort((e,t)=>t.priority-e.priority)}waitFor(e,t=null){return new Promise((i,n)=>{let s=this.subscribeOnce(e,e=>{i(e)});t&&setTimeout(()=>{s(),n(Error(`Timeout waiting for event: ${e}`))},t)})}forwardToBackend(e,t){if(this.webuiAvailable&&void 0!==window.webui)try{let i=JSON.stringify({event:e,data:t,timestamp:Date.now(),source:"frontend"});window.webui.run(`handleFrontendEvent('${i}')`),console.log(`Forwarded event to backend: ${e}`,{data:t})}catch(t){console.error(`Error forwarding event to backend: ${e}`,t)}else console.warn(`WebUI not available, cannot forward event: ${e}`)}listenFromBackend(e,t){let i=e=>{t(e.detail||e)},n=this.generateId();return this.backendListeners.set(n,{eventName:e,handler:i}),window.addEventListener(e,i),()=>{window.removeEventListener(e,i),this.backendListeners.delete(n)}}initWebUIHandlers(){this.webuiAvailable?(window.handleBackendEvent=e=>{try{let t=JSON.parse(e);console.log("Received event from backend:",t),this.emit(t.event||"backend.event",t.data,{source:"backend",originalEvent:t})}catch(e){console.error("Error handling backend event:",e)}},console.log("WebUI event handlers initialized")):console.warn("WebUI not available, skipping WebUI handlers initialization")}async sendToBackendWithResponse(e,t,i=5e3){return new Promise((n,s)=>{let r,a=`${e}.response`,o=e=>{clearTimeout(r),window.removeEventListener(a,o),n(e.detail||e)};window.addEventListener(a,o),r=setTimeout(()=>{window.removeEventListener(a,o),s(Error(`Timeout waiting for response to ${e}`))},i),this.forwardToBackend(e,t)})}};n.use(e=>{console.log(`[EVENT BUS] Event emitted: ${e.name}`,{id:e.id,timestamp:new Date(e.timestamp).toISOString(),data:e.data,metadata:e.metadata})}),n.initWebUIHandlers();let{subscribe:s,subscribeOnce:r,unsubscribe:a,emit:o,use:d,getHistory:l,clearHistory:c,getEventNames:u,getListenerCount:h,waitFor:m,forwardToBackend:E,listenFromBackend:b,sendToBackendWithResponse:w}=n,v={COUNTER_INCREMENT:"counter.increment",COUNTER_RESET:"counter.reset",COUNTER_VALUE_CHANGED:"counter.value_changed",DATABASE_CONNECTED:"database.connected",DATABASE_DISCONNECTED:"database.disconnected",USERS_FETCHED:"database.users_fetched",USER_ADDED:"database.user_added",USER_UPDATED:"database.user_updated",USER_DELETED:"database.user_deleted",SYSTEM_INFO_REQUESTED:"system.info_requested",SYSTEM_INFO_RECEIVED:"system.info_received",WEBUI_CONNECTED:"webui.connected",WEBUI_READY:"webui.ready",WEBUI_DISCONNECTED:"webui.disconnected",CUSTOM:"custom"}}}]);
//# sourceMappingURL=202.d495277b.js.map